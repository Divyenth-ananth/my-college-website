<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Starlight Guardian: IIT Tirupati</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: radial-gradient(circle at center, #0d1b2a, #1b263b);
            font-family: 'Orbitron', sans-serif;
            overflow: hidden;
        }
        #gameContainer {
            position: relative;
            width: 800px;
            height: 600px;
            border-radius: 15px;
            border: 2px solid #00ced1;
        }
        canvas {
            background: #0d1b2a;
            border-radius: 15px;
        }
        #ui {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: #1e90ff;
            padding: 10px 25px;
            border-radius: 25px;
            color: #fff;
            display: flex;
            gap: 30px;
        }
        #ui span {
            font-size: 20px;
        }
        #energyBar {
            position: absolute;
            top: 50px;
            left: 50%;
            transform: translateX(-50%);
            width: 200px;
            height: 20px;
            background: #333;
            border: 2px solid #fff;
            border-radius: 10px;
        }
        #energyFill {
            height: 100%;
            background: #00ced1;
            border-radius: 8px;
            transition: width 0.3s;
        }
        #title {
            position: absolute;
            top: -60px;
            width: 100%;
            text-align: center;
            font-size: 32px;
            color: #00ced1;
        }
        #levelUp {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 48px;
            color: #ffd700;
            opacity: 0;
            pointer-events: none;
        }
        #factBox {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #0d1b2a;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #fffacd;
            color: #fff;
            font-size: 16px;
            text-align: center;
            max-width: 400px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s;
        }
        @keyframes fadeOut {
            to { opacity: 0; }
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
    <div id="gameContainer">
        <div id="title">Starlight Guardian: IIT Tirupati</div>
        <div id="ui">
            <span id="stars">Stars: 0</span>
            <span id="energy">Energy: 50</span>
            <span id="level">Level: 1</span>
            <span id="combo">Combo: 0x</span>
            <span id="timer">Time: 60</span>
            <span id="lamps">Lamps Off: 0/3</span>
        </div>
        <div id="energyBar"><div id="energyFill" style="width: 100%;"></div></div>
        <div id="levelUp">Level Up!</div>
        <div id="factBox"></div>
        <canvas id="gameCanvas" width="800" height="600"></canvas>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const starsUI = document.getElementById('stars');
        const energyUI = document.getElementById('energy');
        const levelUI = document.getElementById('level');
        const comboUI = document.getElementById('combo');
        const timerUI = document.getElementById('timer');
        const lampsUI = document.getElementById('lamps');
        const levelUpText = document.getElementById('levelUp');
        const factBox = document.getElementById('factBox');
        const energyFill = document.getElementById('energyFill');

        // Sound effects
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(frequency, duration) {
            const oscillator = audioCtx.createOscillator();
            oscillator.type = 'sine';
            oscillator.frequency.value = frequency;
            oscillator.connect(audioCtx.destination);
            oscillator.start();
            setTimeout(() => oscillator.stop(), duration);
        }

        // Light pollution facts
        const facts = [
            "Light pollution hides 90% of stars in India’s cities.",
            "Birds migrate off course due to bright urban lights.",
            "Over 1 billion kWh could be saved yearly by dimming lights.",
            "Turtles avoid nesting on brightly lit beaches."
        ];
        let lastFactEnergy = 50;

        // Game state
        let isPaused = true; // Start paused for intro
        let timeLeft = 60; // 60 seconds
        let lastTime = performance.now();

        // Player (Guardian)
        const player = {
            x: 50,
            y: 50,
            width: 40,
            height: 60,
            speed: 6,
            energy: 50,
            starsSaved: 0,
            level: 1,
            lampsDimmed: 0,
            lampsToNextLevel: 3, // 3 lamps per level
            combo: 0,
            comboTimer: 0,
            animationFrame: 0
        };

        // Light Pollution Sources (Lamps with traits)
        const lampTypes = [
            { color: '#ff4500', damage: 5, speed: 0 }, // Standard
            { color: '#ff1493', damage: 7, speed: 1 }, // Fast Pink
            { color: '#9400d3', damage: 10, speed: 0 } // Heavy Purple
        ];
        const lamps = [
            { x: 700, y: 500, brightness: 50, type: lampTypes[0], animationFrame: 0, dx: 0, dy: 0 }
        ];

        // Stars
        const stars = [
            { x: Math.random() * 760, y: Math.random() * 560, size: 20, animationFrame: 0 }
        ];

        // Keyboard controls
        const keys = {};
        window.addEventListener('keydown', (e) => keys[e.key] = true);
        window.addEventListener('keyup', (e) => keys[e.key] = false);

        // Collision detection
        function isColliding(a, b) {
            return a.x < b.x + (b.width || 40) &&
                   a.x + a.width > b.x &&
                   a.y < b.y + (b.height || 40) &&
                   a.y + a.height > b.y;
        }

        // Level up logic (based on lamps dimmed)
        function levelUp() {
            player.level++;
            player.lampsDimmed = 0;
            player.lampsToNextLevel += 2;
            player.speed += 1;
            const newLampType = lampTypes[Math.min(player.level - 1, lampTypes.length - 1)];
            lamps.push({ 
                x: Math.random() * 760, 
                y: Math.random() * 560, 
                brightness: 50 + player.level * 10, 
                type: newLampType, 
                animationFrame: 0, 
                dx: newLampType.speed * (Math.random() > 0.5 ? 1 : -1), 
                dy: newLampType.speed * (Math.random() > 0.5 ? 1 : -1) 
            });
            levelUpText.style.opacity = 1;
            levelUpText.style.animation = 'fadeOut 1s forwards';
            playSound(880, 300);
            setTimeout(() => levelUpText.style.animation = '', 1000);
        }

        // Show fact and pause
        function showFact() {
            const energyThresholds = [37, 25, 12];
            const currentEnergy = Math.floor(player.energy);
            if (energyThresholds.includes(currentEnergy) && currentEnergy < lastFactEnergy) {
                isPaused = true;
                factBox.textContent = facts[Math.floor(Math.random() * facts.length)];
                factBox.style.opacity = 1;
                setTimeout(() => {
                    factBox.style.opacity = 0;
                    isPaused = false;
                    lastFactEnergy = currentEnergy;
                    requestAnimationFrame(gameLoop);
                }, 5000);
            }
        }

        // Game over (energy or time)
        function gameOver() {
            isPaused = true;
            alert(`Times Up! Stars Saved: ${player.starsSaved}, Level: ${player.level}`);
            player.energy = 50;
            player.starsSaved = 0;
            player.level = 1;
            player.lampsDimmed = 0;
            player.lampsToNextLevel = 3;
            player.speed = 6;
            player.combo = 0;
            timeLeft = 60;
            lamps.length = 1;
            lamps[0] = { x: 700, y: 500, brightness: 50, type: lampTypes[0], animationFrame: 0, dx: 0, dy: 0 };
            lastFactEnergy = 50;
            isPaused = false;
            requestAnimationFrame(gameLoop);
        }

        // Game loop
        function update() {
            if (isPaused) return;

            // Update timer
            const currentTime = performance.now();
            const deltaTime = (currentTime - lastTime) / 1000;
            lastTime = currentTime;
            timeLeft -= deltaTime;
            timerUI.textContent = `Time: ${Math.max(0, Math.floor(timeLeft))}`;
            if (timeLeft <= 0) {
                gameOver();
                return;
            }

            player.animationFrame = (player.animationFrame + 0.1) % (Math.PI * 2);
            lamps.forEach(lamp => lamp.animationFrame = (lamp.animationFrame + 0.05) % (Math.PI * 2));
            stars.forEach(star => star.animationFrame = (star.animationFrame + 0.15) % (Math.PI * 2));

            // Player movement
            if (keys['ArrowUp'] && player.y > 0) player.y -= player.speed;
            if (keys['ArrowDown'] && player.y < canvas.height - player.height) player.y += player.speed;
            if (keys['ArrowLeft'] && player.x > 0) player.x -= player.speed;
            if (keys['ArrowRight'] && player.x < canvas.width - player.width) player.x += player.speed;

            // Lamp movement
            lamps.forEach(lamp => {
                if (lamp.type.speed > 0) {
                    lamp.x += lamp.dx;
                    lamp.y += lamp.dy;
                    if (lamp.x < 0 || lamp.x > canvas.width - 40) lamp.dx *= -1;
                    if (lamp.y < 0 || lamp.y > canvas.height - 40) lamp.dy *= -1;
                }
            });

            // Collision with lamps
            lamps.forEach(lamp => {
                if (isColliding(player, lamp) && lamp.brightness > 0) {
                    player.energy -= lamp.type.damage / 60;
                    lamp.brightness -= 2;
                    if (lamp.brightness <= 0) {
                        lamp.x = Math.random() * 760;
                        lamp.y = Math.random() * 560;
                        lamp.brightness = 50 + player.level * 10;
                        lamp.dx = lamp.type.speed * (Math.random() > 0.5 ? 1 : -1);
                        lamp.dy = lamp.type.speed * (Math.random() > 0.5 ? 1 : -1);
                        player.lampsDimmed++;
                        playSound(440, 100);
                        if (player.lampsDimmed >= player.lampsToNextLevel) levelUp();
                    }
                    if (player.energy <= 0) gameOver();
                    showFact();
                }
            });

            // Collision with stars (combo system, score only)
            stars.forEach((star, index) => {
                if (isColliding(player, star)) {
                    player.comboTimer = 120;
                    player.combo++;
                    player.starsSaved += player.combo;
                    stars.splice(index, 1);
                    stars.push({ x: Math.random() * 760, y: Math.random() * 560, size: 20, animationFrame: 0 });
                    playSound(660, 150);
                }
            });
            if (player.comboTimer > 0) player.comboTimer--;
            else player.combo = 0;

            // Update UI
            starsUI.textContent = `Stars: ${player.starsSaved}`;
            energyUI.textContent = `Energy: ${Math.floor(player.energy)}`;
            levelUI.textContent = `Level: ${player.level}`;
            comboUI.textContent = `Combo: ${player.combo}x`;
            lampsUI.textContent = `Lamps Off: ${player.lampsDimmed}/${player.lampsToNextLevel}`;
            energyFill.style.width = `${(player.energy / 50) * 100}%`;
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Draw starry background
            for (let i = 0; i < 50; i++) {
                ctx.fillStyle = '#ffffff';
                ctx.beginPath();
                ctx.arc(Math.random() * 800, Math.random() * 600, Math.random() * 2, 0, Math.PI * 2);
                ctx.fill();
            }

            // Draw player (Guardian)
            ctx.save();
            ctx.translate(player.x + 20, player.y + 30);
            ctx.fillStyle = '#00ced1';
            ctx.fillRect(-15, -30, 30, 40);
            ctx.fillStyle = '#1e90ff';
            ctx.beginPath();
            ctx.arc(0, -40, 12, 0, Math.PI * 2);
            ctx.fill();
            ctx.fillStyle = '#4682b4';
            ctx.beginPath();
            ctx.moveTo(-15, -10);
            ctx.lineTo(0, -20 + Math.sin(player.animationFrame) * 5);
            ctx.lineTo(15, -10);
            ctx.fill();
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(-5, -25, 10, 5);
            ctx.restore();

            // Draw lamps
            lamps.forEach(lamp => {
                if (lamp.brightness > 0) {
                    ctx.save();
                    ctx.translate(lamp.x + 20, lamp.y + 20);
                    ctx.fillStyle = '#8b4513';
                    ctx.fillRect(-10, 10, 20, 30);
                    ctx.fillStyle = lamp.type.color;
                    ctx.beginPath();
                    ctx.moveTo(-15, 0);
                    ctx.lineTo(0, -15 + Math.sin(lamp.animationFrame) * 3);
                    ctx.lineTo(15, 0);
                    ctx.fill();
                    ctx.fillStyle = '#ffa500';
                    ctx.fillRect(-5, -10, 10, 5);
                    ctx.restore();
                }
            });

            // Draw stars (classic five-pointed star)
            stars.forEach(star => {
                ctx.save();
                ctx.translate(star.x + star.size / 2, star.y + star.size / 2);
                ctx.fillStyle = '#ffffff';
                ctx.beginPath();
                const outerRadius = star.size;
                const innerRadius = star.size / 2.5; // Adjusted for sharper points
                for (let i = 0; i < 5; i++) {
                    const angle = (Math.PI * 2 / 5) * i - Math.PI / 2;
                    // Outer point
                    ctx.lineTo(
                        Math.cos(angle) * outerRadius,
                        Math.sin(angle) * outerRadius
                    );
                    // Inner point
                    const innerAngle = angle + (Math.PI / 5);
                    ctx.lineTo(
                        Math.cos(innerAngle) * innerRadius * (1 + Math.sin(star.animationFrame) * 0.1),
                        Math.sin(innerAngle) * innerRadius * (1 + Math.sin(star.animationFrame) * 0.1)
                    );
                }
                ctx.closePath();
                ctx.fill();
                ctx.restore();
            });

            // Draw labels
            ctx.fillStyle = '#fff';
            ctx.font = '14px Orbitron';
            ctx.fillText(Guardian, player.x, player.y - 50);
            lamps.forEach(lamp => {
                if (lamp.brightness > 0) ctx.fillText(`Lamp: ${lamp.brightness}, lamp.x, lamp.y - 20`);
            });
        }

        function gameLoop() {
            if (!isPaused) {
                update();
                draw();
            }
            requestAnimationFrame(gameLoop);
        }

        // Start the game with instructions
        alert('Welcome to Starlight Guardian at IIT Tirupati!\n\nYour Mission (60 seconds):\n- Use arrow keys to move the Guardian.\n- Dim 3 lamps by touching them to level up (more per level).\n- Collect stars quickly for combo points to boost your score.\n- Watch your energy—don’t let it hit zero!\n\nProtect the night sky—start now!');
        isPaused = false;
        lastTime = performance.now();
        gameLoop();
    </script>
</body>
</html>