<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lights Out: The Night Sky Challenge</title>
    <style>
        body {
            margin: 0;
            font-family: 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #001f3f, #000000);
            color: #fff;
            overflow: hidden;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }
        .starfield {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: transparent;
            z-index: -1;
            pointer-events: none;
        }
        .starfield::before {
            content: "";
            position: absolute;
            width: 2px;
            height: 2px;
            background: #fff;
            border-radius: 50%;
            box-shadow: 
                100px 150px 0 0 #fff, 200px 300px 0 0 #fff, 300px 100px 0 1px #fff,
                400px 250px 0 0 #fff, 500px 200px 0 1px #fff, 600px 350px 0 0 #fff,
                700px 120px 0 1px #fff, 800px 280px 0 0 #fff, 150px 400px 0 1px #fff,
                250px 50px 0 0 #fff, 350px 320px 0 1px #fff, 450px 180px 0 0 #fff;
            animation: twinkle 3s infinite alternate;
        }
        .starfield::after {
            content: "";
            position: absolute;
            width: 3px;
            height: 3px;
            background: #fff;
            border-radius: 50%;
            box-shadow: 
                50px 200px 0 0 #fff, 150px 350px 0 1px #fff, 250px 120px 0 0 #fff,
                350px 280px 0 1px #fff, 450px 100px 0 0 #fff, 550px 300px 0 1px #fff,
                650px 150px 0 0 #fff, 750px 250px 0 1px #fff, 850px 180px 0 0 #fff;
            animation: twinkle 4s infinite alternate;
        }
        @keyframes twinkle {
            0% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        .dialogue-box {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 700px;
            height: 400px;
            background: linear-gradient(135deg, rgba(0, 0, 51, 0.9), rgba(51, 51, 102, 0.9));
            border-radius: 20px;
            box-shadow: 0 0 30px rgba(0, 204, 255, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10;
            padding: 20px;
            transition: opacity 0.5s;
        }
        #home-screen {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 700px;
            height: 400px;
            background: linear-gradient(135deg, rgba(0, 0, 51, 0.9), rgba(51, 51, 102, 0.9));
            border-radius: 20px;
            box-shadow: 0 0 30px rgba(0, 204, 255, 0.5);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 15;
            padding: 20px;
            transition: opacity 0.5s;
        }
        #home-screen h1 {
            font-size: 48px;
            text-shadow: 0 0 15px #00ccff, 0 0 30px #0066ff;
            margin: 0;
            text-align: center;
        }
        .tagline {
            font-size: 20px;
            color: #00ff99;
            text-shadow: 0 0 10px #00ff99, 0 0 20px #00cc66;
            margin: 10px 0 30px 0;
            text-align: center;
            opacity: 0;
            animation: fadeIn 1s ease-in forwards 0.5s;
        }
        @keyframes fadeIn {
            to { opacity: 1; }
        }
        .home-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-top: 20px;
        }
        .start-button-container {
            margin-top: 30px;
        }
        .home-btn {
            padding: 12px 30px;
            font-size: 18px;
            color: #fff;
            background: linear-gradient(45deg, #00ccff, #0066ff);
            border: 2px solid #00ff99;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 204, 255, 0.5);
            position: relative;
            overflow: hidden;
        }
        .start-btn {
            padding: 15px 40px;
            font-size: 22px;
            color: #fff;
            background: linear-gradient(45deg, #ff3333, #ff6666);
            border: 2px solid #ffcc00;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 6px 20px rgba(255, 51, 51, 0.7);
            position: relative;
            overflow: hidden;
        }
        .home-btn::before, .start-btn::before {
            content: "";
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.6s ease, height 0.6s ease;
        }
        .home-btn:hover::before {
            width: 200px;
            height: 200px;
        }
        .start-btn:hover::before {
            width: 250px;
            height: 250px;
        }
        .home-btn:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 8px 25px rgba(0, 204, 255, 0.8);
            background: linear-gradient(45deg, #33ddff, #0099ff);
        }
        .start-btn:hover {
            transform: translateY(-5px) scale(1.1);
            box-shadow: 0 10px 30px rgba(255, 51, 51, 0.9);
            background: linear-gradient(45deg, #ff6666, #ff9999);
        }
        #game-container {
            width: 900px;
            height: 650px;
            position: relative;
            display: none;
            background: rgba(0, 0, 51, 0.3);
            border-radius: 20px;
            box-shadow: 0 0 50px rgba(0, 204, 255, 0.3);
            backdrop-filter: blur(5px);
            z-index: 1;
        }
        #start-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: rgba(0, 0, 51, 0.8);
            z-index: 10;
            border-radius: 20px;
            transition: opacity 0.5s;
            display: none;
            padding: 20px;
            box-sizing: border-box;
        }
        #start-screen h1 {
            font-size: 72px;
            text-shadow: 0 0 20px #00ccff, 0 0 40px #0066ff;
            margin-bottom: 10px;
        }
        #start-screen h3 {
            font-size: 28px;
            text-shadow: 0 0 15px #00ccff;
            margin-bottom: 30px;
        }
        #countdown {
            font-size: 100px;
            font-weight: bold;
            text-shadow: 0 0 25px #ff6666, 0 0 50px #ff3333;
            color: #ff6666;
            animation: pulse 1s infinite alternate;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            100% { transform: scale(1.05); }
        }
        #dialogue-content, #end-dialogue-content, #about-content {
            text-align: center;
            color: #fff;
        }
        #dialogue-title, #end-dialogue-title, #about-title {
            font-size: 48px;
            text-shadow: 0 0 15px #00ccff, 0 0 30px #0066ff;
            margin-bottom: 20px;
        }
        #dialogue-text, #end-dialogue-text, #about-text {
            font-size: 20px;
            line-height: 1.6;
            text-shadow: 0 0 5px #000;
            max-width: 600px;
            margin: 0 auto 20px;
        }
        .dialogue-btn {
            padding: 12px 30px;
            font-size: 18px;
            color: #fff;
            background: linear-gradient(45deg, #00ccff, #0066ff);
            border: none;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 204, 255, 0.5);
            margin: 5px;
        }
        .dialogue-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 204, 255, 0.8);
        }
        #start-game-btn {
            padding: 12px 30px;
            font-size: 18px;
            color: #fff;
            background: linear-gradient(45deg, #ff3333, #ff6666);
            border: 2px solid #ffcc00;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 6px 20px rgba(255, 51, 51, 0.7);
            margin: 5px;
        }
        #start-game-btn:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 10px 30px rgba(255, 51, 51, 0.9);
            background: linear-gradient(45deg, #ff6666, #ff9999);
        }
        h1 {
            font-size: 64px;
            text-shadow: 0 0 15px #00ccff, 0 0 30px #0066ff;
            margin: 0;
        }
        h3 {
            font-size: 24px;
            margin: 10px 0;
            text-shadow: 0 0 10px #00ccff;
        }
        #difficulty-container {
            display: none;
            position: absolute;
            bottom: 20px;
            z-index: 11;
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-width: 300px;
        }
        #difficulty-label {
            font-size: 22px;
            margin-bottom: 15px;
            text-shadow: 0 0 10px #00ccff;
            color: #fff;
        }
        #difficulty {
            padding: 12px;
            font-size: 18px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
            border: 2px solid #00ccff;
            width: 100%;
            max-width: 250px;
            box-shadow: 0 0 10px rgba(0, 204, 255, 0.5);
            appearance: none;
            cursor: pointer;
            text-align: center;
        }
        #difficulty option {
            background: rgba(0, 0, 51, 0.9);
            color: #fff;
            padding: 10px;
        }
        #difficulty:focus {
            outline: none;
            border-color: #00ff99;
        }
        #status-bar {
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            height: 60px;
            background: linear-gradient(90deg, rgba(0, 0, 51, 0.9), rgba(51, 51, 102, 0.9));
            border-radius: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            box-shadow: 0 4px 15px rgba(0, 204, 255, 0.3);
            z-index: 5;
        }
        .status-item {
            font-size: 20px;
            font-weight: bold;
            text-shadow: 0 0 5px #000;
        }
        #clarity {
            color: #00ff99;
            text-shadow: 0 0 10px #00ff99, 0 0 5px #000;
        }
        .zones-container {
            position: absolute;
            top: 360px;
            left: 60px;
            right: 60px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 5;
        }
        .zone {
            width: 220px;
            height: 120px;
            border-radius: 15px;
            text-align: center;
            line-height: 120px;
            font-size: 22px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease, opacity 0.5s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            border: 2px solid rgba(255, 255, 255, 0.8);
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            position: relative;
            z-index: 5;
        }
        .zone:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(0, 204, 255, 0.7);
        }
        .selected { border: 4px solid #00ccff; box-shadow: 0 0 25px #00ccff; }
        #residential { 
            background-image: url('https://images.unsplash.com/photo-1600585154340-be6161a56a0c?ixlib=rb-4.0.3&auto=format&fit=crop&w=220&h=120&q=80'); 
        }
        #commercial { 
            background-image: url('https://images.unsplash.com/photo-1480714378408-67cf0d13bc1b?ixlib=rb-4.0.3&auto=format&fit=crop&w=220&h=120&q=80'); 
        }
        #park {
            background-image: url('images/park.jpg');
            background-size: cover;
            background-position: center;
        }
        .zone span {
            position: relative;
            z-index: 1;
            background: rgba(0, 0, 51, 0.7);
            padding: 5px 10px;
            border-radius: 5px;
        }
        .button-container {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            z-index: 5;
        }
        .solution-title {
            font-size: 22px;
            font-weight: bold;
            text-shadow: 0 0 10px #00ccff;
            color: #fff;
            margin-bottom: 10px;
        }
        .solution-buttons {
            display: flex;
            flex-direction: row;
            gap: 20px;
            justify-content: center;
            width: 100%;
            max-width: 800px;
        }
        .solution-btn {
            padding: 15px 30px;
            font-size: 18px;
            color: #fff;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 204, 255, 0.5);
            background: linear-gradient(45deg, #00ccff, #0066ff);
            position: relative;
            flex: 1;
            max-width: 200px;
        }
        .solution-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 204, 255, 0.8);
        }
        .solution-btn:hover::after {
            content: attr(data-description);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 51, 0.9);
            color: #fff;
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 14px;
            white-space: nowrap;
            z-index: 10;
            box-shadow: 0 4px 15px rgba(0, 204, 255, 0.5);
            pointer-events: none;
        }
        #btn-led { background: linear-gradient(45deg, #0066ff, #33ccff); }
        #btn-motion { background: linear-gradient(45deg, #00cc00, #66ff66); }
        #btn-dim { background: linear-gradient(45deg, #ffcc00, #ffff66); }
        .solution-btn.upgraded {
            border: 2px solid #ffcc00;
            box-shadow: 0 0 15px #ffcc00;
        }
        .star {
            position: absolute;
            width: 12px;
            height: 12px;
            opacity: 0;
            transition: opacity 0.8s ease, transform 0.5s ease;
            z-index: 2;
        }
        .star.visible {
            opacity: 1;
            transform: scale(1.2);
            animation: twinkle 2s infinite alternate;
        }
        .star.scattered {
            opacity: 0.5;
            transform: scale(0.8);
            animation: twinkle 3s infinite alternate;
        }
        .star svg {
            width: 100%;
            height: 100%;
            fill: #fff;
            filter: drop-shadow(0 0 3px rgba(255, 255, 255, 0.8));
        }
        .star-label {
            transition: opacity 0.5s ease;
            text-shadow: 0 0 5px #00ff99;
        }
        #constellation-lines {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            z-index: 3;
            pointer-events: none;
        }
        #constellation-lines.visible {
            opacity: 1;
            transition: opacity 1s ease;
        }
        #constellation-lines path {
            stroke: #00ff99;
            stroke-width: 2;
            stroke-dasharray: 500;
            stroke-dashoffset: 500;
            animation: drawLine 2s forwards, glow 1.5s infinite alternate;
        }
        @keyframes drawLine {
            to { stroke-dashoffset: 0; }
        }
        @keyframes glow {
            0% { stroke: #00ff99; filter: drop-shadow(0 0 2px #00ff99); }
            100% { stroke: #33ffcc; filter: drop-shadow(0 0 5px #33ffcc); }
        }
        #event-message, #action-message {
            position: absolute;
            width: 100%;
            text-align: center;
            font-size: 20px;
            font-weight: bold;
            text-shadow: 0 0 10px #000;
            opacity: 0;
            transition: opacity 0.5s;
            z-index: 5;
        }
        #event-message { top: 80px; color: #ffcc00; }
        #action-message { top: 120px; color: #ffffff; }
        #zone-table {
            width: 300px;
            height: fit-content;
            background: rgba(0, 0, 51, 0.8);
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 4px 15px rgba(0, 204, 255, 0.3);
            display: none;
            flex-direction: column;
            align-items: center;
            backdrop-filter: blur(5px);
            z-index: 5;
            position: absolute;
            right: 20px;
            top: 80px;
        }
        #zone-table h2 {
            font-size: 20px;
            text-align: center;
            margin: 0 0 10px 0;
            text-shadow: 0 0 10px #00ccff;
        }
        #zone-table table {
            width: 100%;
            border-collapse: collapse;
            color: #fff;
            font-size: 14px;
        }
        #zone-table th, #zone-table td {
            padding: 8px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.8);
        }
        #zone-table th {
            background: linear-gradient(90deg, rgba(0, 0, 51, 0.9), rgba(51, 51, 102, 0.9));
            font-weight: bold;
        }
    </style>
</head>
<body>

    <div class="starfield"></div>
    <div id="home-screen" class="dialogue-box">
        <h1>Lights Out: The Night Sky Challenge</h1>
        <p class="tagline">Save the Stars from Light Pollution!</p>
        <div class="home-buttons">
            <button id="about-btn" class="home-btn">About the Game</button>
            <button id="how-to-play-btn" class="home-btn">How to Play</button>
        </div>
        <div class="start-button-container">
            <button id="start-btn" class="start-btn">Start Game</button>
        </div>
    </div>

    <div id="about-dialogue" class="dialogue-box" style="display: none;">
        <div id="about-content">
            <h1 id="about-title">About the Game</h1>
            <p id="about-text">
                Lights Out: The Night Sky Challenge is an interactive game where you combat light pollution to reveal stunning constellations. Manage your budget, choose smart lighting solutions, and save the night sky in this cosmic adventure. Created to raise awareness about light pollution’s impact, it’s a fun blend of strategy and stargazing!
            </p>
            <button id="about-back-btn" class="dialogue-btn">Back to Main Page</button>
        </div>
    </div>

    <div id="instructions-dialogue" class="dialogue-box" style="display: none;">
        <div id="dialogue-content">
            <h1 id="dialogue-title">How to Play</h1>
            <p id="dialogue-text"></p>
            <div>
                <button id="dialogue-back-btn" class="dialogue-btn" style="display: none;">Back</button>
                <button id="dialogue-next-btn" class="dialogue-btn">Next</button>
                <button id="instructions-back-btn" class="dialogue-btn" style="display: none;">Back to Main Page</button>
            </div>
        </div>
    </div>

    <div id="start-dialogue" class="dialogue-box" style="display: none;">
        <div id="dialogue-content">
            <h1 id="dialogue-title">Start Game</h1>
            <p id="dialogue-text">Select your difficulty and begin!</p>
            <div id="difficulty-container">
                <label id="difficulty-label" for="difficulty">Select Difficulty:</label>
                <select id="difficulty">
                    <option value="easy">Easy</option>
                    <option value="normal" selected>Normal</option>
                    <option value="hard">Hard</option>
                </select>
            </div>
            <div>
                <button id="start-game-btn">Start</button>
                <button id="start-back-btn" class="dialogue-btn">Back to Main Page</button>
            </div>
        </div>
    </div>

    <div id="start-screen">
        <h1>Lights Out</h1>
        <h3>The Night Sky Challenge</h3>
        <div id="countdown"></div>
    </div>

    <div id="end-dialogue" class="dialogue-box" style="display: none;">
        <div id="end-dialogue-content">
            <h1 id="end-dialogue-title"></h1>
            <p id="end-dialogue-text"></p>
            <button id="end-dialogue-btn" class="dialogue-btn">Back to Main Page</button>
        </div>
    </div>

    <div id="game-container">
        <div id="status-bar">
            <span id="budget" class="status-item">Budget: $1000</span>
            <span id="timer" class="status-item">Time: 4:00</span>
            <span id="clarity" class="status-item">Stars: 0</span>
        </div>
        <div id="event-message"></div>
        <div id="action-message"></div>
        <svg id="constellation-lines"></svg>
        <div class="zones-container">
            <div id="residential" class="zone"><span>Residential</span></div>
            <div id="commercial" class="zone"><span>Commercial</span></div>
            <div id="park" class="zone"><span>Park</span></div>
        </div>
        <div class="button-container">
            <div class="solution-title">Select a Lighting Solution</div>
            <div class="solution-buttons">
                <button id="btn-led" class="solution-btn" data-description="Redirects light downward to reduce sky glow, ideal for homes.">Shielded LEDs ($200)</button>
                <button id="btn-motion" class="solution-btn" data-description="Lights activate only when needed, perfect for busy areas.">Motion Sensors ($150)</button>
                <button id="btn-dim" class="solution-btn" data-description="Lowers brightness to save energy, great for quiet spaces.">Dim Lights ($100)</button>
            </div>
        </div>
    </div>

    <div id="zone-table">
        <h2>Light Pollution Status</h2>
        <table>
            <thead>
                <tr>
                    <th>Zone</th>
                    <th>Original Light</th>
                    <th>Current Light</th>
                    <th>% Reduced</th>
                </tr>
            </thead>
            <tbody id="table-body">
                <tr>
                    <td>Residential</td>
                    <td>80</td>
                    <td>80</td>
                    <td>0%</td>
                </tr>
                <tr>
                    <td>Commercial</td>
                    <td>90</td>
                    <td>90</td>
                    <td>0%</td>
                </tr>
                <tr>
                    <td>Park</td>
                    <td>30</td>
                    <td>30</td>
                    <td>0%</td>
                </tr>
            </tbody>
        </table>
    </div>

    <script>
        const homeScreen = document.getElementById('home-screen');
        const startBtn = document.getElementById('start-btn');
        const aboutBtn = document.getElementById('about-btn');
        const howToPlayBtn = document.getElementById('how-to-play-btn');
        const aboutDialogue = document.getElementById('about-dialogue');
        const aboutBackBtn = document.getElementById('about-back-btn');
        const instructionsDialogue = document.getElementById('instructions-dialogue');
        const startDialogue = document.getElementById('start-dialogue');
        const dialogueText = document.getElementById('dialogue-text');
        const dialogueNextBtn = document.getElementById('dialogue-next-btn');
        const dialogueBackBtn = document.getElementById('dialogue-back-btn');
        const instructionsBackBtn = document.getElementById('instructions-back-btn');
        const startGameBtn = document.getElementById('start-game-btn');
        const startBackBtn = document.getElementById('start-back-btn');

        const dialogueSteps = [
            "Greetings, sky warrior! In Lights Out, you’ll battle light pollution to reclaim the stars. It’s like a galactic rescue mission—no dish soap required!",
            "Step 1: Click a zone—Residential, Commercial, or Park. It’s like picking which neighbor to annoy first. Don’t worry, they’ll thank you later when they see Orion’s abs!",
            "Step 2: Pick a solution—Shielded LEDs, Motion Sensors, or Dim Lights. Each costs budget, so don’t blow it all on fancy lights like it’s a disco apocalypse!",
            "Step 3: Match the right solution to the zone for a sweet $50 bonus. Hint: LEDs love homes, Motion Sensors dig busy streets, and Dim Lights are park chillers. Hover over buttons to snoop the deets!",
            "Step 4: Right-click a zone after a solution to upgrade it—once per trick, fancy pants! Costs more, but it’s like giving your lights a superhero cape!",
            "Step 5: Reduce pollution to reveal a constellation (ooh, shiny!). Then zap ALL pollution to zero to win. Time’s ticking—don’t let the sky ghost you!",
            "Ready, champ? Click 'Start Game' on the main screen to pick your difficulty and begin!"
        ];

        let dialogueIndex = 0;

        function showHowToPlay() {
            dialogueText.textContent = dialogueSteps[dialogueIndex];
            dialogueNextBtn.style.display = dialogueIndex < dialogueSteps.length - 1 ? 'inline-block' : 'none';
            dialogueBackBtn.style.display = dialogueIndex > 0 ? 'inline-block' : 'none';
            instructionsBackBtn.style.display = dialogueIndex === dialogueSteps.length - 1 ? 'inline-block' : 'none';
        }

        function nextDialogue() {
            if (dialogueIndex < dialogueSteps.length - 1) {
                dialogueIndex++;
                showHowToPlay();
            }
        }

        function prevDialogue() {
            if (dialogueIndex > 0) {
                dialogueIndex--;
                showHowToPlay();
            }
        }

        function startGame() {
            playSound(clickSound);
            initGame();
            generateStars();
            startDialogue.style.opacity = '0';
            setTimeout(() => {
                startDialogue.style.display = 'none';
                startScreen.style.display = 'flex';
                startScreen.style.opacity = '1';
                startCountdown();
            }, 500);
        }

        homeScreen.style.opacity = '1';
        homeScreen.style.display = 'flex';

        startBtn.addEventListener('click', () => {
            homeScreen.style.opacity = '0';
            setTimeout(() => {
                homeScreen.style.display = 'none';
                startDialogue.style.display = 'flex';
                startDialogue.style.opacity = '0';
                setTimeout(() => {
                    startDialogue.style.opacity = '1';
                    document.getElementById('difficulty-container').style.display = 'flex';
                }, 10);
            }, 500);
        });

        startGameBtn.addEventListener('click', startGame);

        startBackBtn.addEventListener('click', () => {
            startDialogue.style.opacity = '0';
            setTimeout(() => {
                startDialogue.style.display = 'none';
                homeScreen.style.display = 'flex';
                homeScreen.style.opacity = '0';
                setTimeout(() => homeScreen.style.opacity = '1', 10);
            }, 500);
        });

        aboutBtn.addEventListener('click', () => {
            homeScreen.style.opacity = '0';
            setTimeout(() => {
                homeScreen.style.display = 'none';
                aboutDialogue.style.display = 'flex';
                aboutDialogue.style.opacity = '0';
                setTimeout(() => aboutDialogue.style.opacity = '1', 10);
            }, 500);
        });

        aboutBackBtn.addEventListener('click', () => {
            aboutDialogue.style.opacity = '0';
            setTimeout(() => {
                aboutDialogue.style.display = 'none';
                homeScreen.style.display = 'flex';
                homeScreen.style.opacity = '0';
                setTimeout(() => homeScreen.style.opacity = '1', 10);
            }, 500);
        });

        howToPlayBtn.addEventListener('click', () => {
            homeScreen.style.opacity = '0';
            setTimeout(() => {
                homeScreen.style.display = 'none';
                instructionsDialogue.style.display = 'flex';
                instructionsDialogue.style.opacity = '0';
                setTimeout(() => {
                    instructionsDialogue.style.opacity = '1';
                    dialogueIndex = 0;
                    showHowToPlay();
                }, 10);
            }, 500);
        });

        dialogueNextBtn.addEventListener('click', nextDialogue);
        dialogueBackBtn.addEventListener('click', prevDialogue);

        instructionsBackBtn.addEventListener('click', () => {
            instructionsDialogue.style.opacity = '0';
            setTimeout(() => {
                instructionsDialogue.style.display = 'none';
                homeScreen.style.display = 'flex';
                homeScreen.style.opacity = '0';
                setTimeout(() => homeScreen.style.opacity = '1', 10);
            }, 500);
        });

        const endDialogue = document.getElementById('end-dialogue');
        const endDialogueTitle = document.getElementById('end-dialogue-title');
        const endDialogueText = document.getElementById('end-dialogue-text');
        const endDialogueBtn = document.getElementById('end-dialogue-btn');

        function showEndDialogue(won) {
            gameContainer.style.display = 'none';
            zoneTable.style.display = 'none';
            endDialogue.style.display = 'flex';
            endDialogue.style.opacity = '1';
            if (won) {
                endDialogueTitle.textContent = "Victory!";
                endDialogueTitle.style.color = '#00ff99';
                endDialogueText.innerHTML = `Night Sky Restored!<br>${currentConstellation.name} Shines!<br><br>Stars Revealed: ${skyClarity}/${clarityGoal}<br>Pollution Reduced: ${totalPollutionReduced}<br>Budget Left: $${budget}<br>Time Bonus: ${timeLeft}s x 10 = ${timeLeft * 10}<br>Final Score: ${score}`;
                playSound(winSound);
            } else {
                endDialogueTitle.textContent = "Time's Up!";
                endDialogueTitle.style.color = '#ff3333';
                endDialogueText.innerHTML = `Sky Faded!<br><br>Stars Revealed: ${skyClarity}/${clarityGoal}<br>Pollution Reduced: ${totalPollutionReduced}<br>Budget Left: $${budget}<br>Time Bonus: ${timeLeft}s x 10 = ${timeLeft * 10}<br>Final Score: ${score}`;
            }
            endDialogueBtn.onclick = () => {
                endDialogue.style.opacity = '0';
                setTimeout(() => {
                    endDialogue.style.display = 'none';
                    homeScreen.style.display = 'flex';
                    homeScreen.style.opacity = '0';
                    setTimeout(() => homeScreen.style.opacity = '1', 10);
                }, 500);
            };
        }

        const gameContainer = document.getElementById('game-container');
        const startScreen = document.getElementById('start-screen');
        const countdownEl = document.getElementById('countdown');
        const budgetEl = document.getElementById('budget');
        const timerEl = document.getElementById('timer');
        const clarityEl = document.getElementById('clarity');
        const eventMessage = document.getElementById('event-message');
        const actionMessage = document.getElementById('action-message');
        const tableBody = document.getElementById('table-body');
        const zoneTable = document.getElementById('zone-table');
        const constellationLines = document.getElementById('constellation-lines');
        const clickSound = document.getElementById('click-sound') || { play: () => {} }; // Fallback for missing audio
        const winSound = document.getElementById('win-sound') || { play: () => {} };
        const eventSound = document.getElementById('event-sound') || { play: () => {} };

        const difficultySettings = {
            easy: { time: 300, budget: 1500, pollutionCreep: 5, creepInterval: 30000 },
            normal: { time: 240, budget: 1000, pollutionCreep: 10, creepInterval: 30000 },
            hard: { time: 180, budget: 800, pollutionCreep: 15, creepInterval: 20000 }
        };

        const zones = {
            residential: { el: document.getElementById('residential'), originalLight: 80, lightLevel: 80 },
            commercial: { el: document.getElementById('commercial'), originalLight: 90, lightLevel: 90 },
            park: { el: document.getElementById('park'), originalLight: 30, lightLevel: 30 }
        };

        const solutions = {
            'btn-led': { 
                cost: 200, 
                effects: { residential: 40, commercial: 25, park: 20 }, 
                name: 'Shielded LEDs',
                optimalZone: 'residential',
                upgradeCost: 300,
                upgraded: false,
                upgradedEffects: { residential: 50, commercial: 30, park: 25 },
                description: 'Redirects light downward to reduce sky glow, ideal for homes.'
            },
            'btn-motion': { 
                cost: 150, 
                effects: { residential: 20, commercial: 25, park: 15 }, 
                name: 'Motion Sensors',
                optimalZone: 'commercial',
                upgradeCost: 250,
                upgraded: false,
                upgradedEffects: { residential: 25, commercial: 35, park: 20 },
                description: 'Lights activate only when needed, perfect for busy areas.'
            },
            'btn-dim': { 
                cost: 100, 
                effects: { residential: 10, commercial: 15, park: 25 }, 
                name: 'Dim Lights',
                optimalZone: 'park',
                upgradeCost: 200,
                upgraded: false,
                upgradedEffects: { residential: 15, commercial: 20, park: 35 },
                description: 'Lowers brightness to save energy, great for quiet spaces.'
            }
        };

        const properConstellations = {
            1: { 
                name: 'Orion', 
                stars: [
                    { name: 'Betelgeuse', x: 300, y: 120 },
                    { name: 'Bellatrix', x: 400, y: 130 },
                    { name: 'Rigel', x: 320, y: 280 },
                    { name: 'Saiph', x: 380, y: 290 },
                    { name: 'Alnitak', x: 340, y: 200 },
                    { name: 'Alnilam', x: 360, y: 210 },
                    { name: 'Mintaka', x: 380, y: 220 }
                ],
                connections: [
                    [0, 4], [1, 6],
                    [4, 5], [5, 6],
                    [4, 2], [6, 3]
                ]
            },
            2: { 
                name: 'Ursa Major', 
                stars: [
                    { name: 'Dubhe', x: 300, y: 130 },
                    { name: 'Merak', x: 340, y: 180 },
                    { name: 'Phecda', x: 380, y: 200 },
                    { name: 'Megrez', x: 420, y: 150 },
                    { name: 'Alioth', x: 460, y: 160 },
                    { name: 'Mizar', x: 500, y: 140 },
                    { name: 'Alkaid', x: 540, y: 120 }
                ],
                connections: [
                    [0, 1], [1, 2], [2, 3], [3, 0],
                    [3, 4], [4, 5], [5, 6]
                ]
            },
            3: { 
                name: 'Cassiopeia', 
                stars: [
                    { name: 'Schedar', x: 300, y: 160 },
                    { name: 'Caph', x: 350, y: 120 },
                    { name: 'Gamma Cas', x: 400, y: 150 },
                    { name: 'Ruchbah', x: 450, y: 130 },
                    { name: 'Epsilon Cas', x: 500, y: 170 }
                ],
                connections: [
                    [0, 1], [1, 2], [2, 3], [3, 4]
                ]
            },
            4: { 
                name: 'Scorpius', 
                stars: [
                    { name: 'Graffias', x: 300, y: 120 },
                    { name: 'Dschubba', x: 340, y: 130 },
                    { name: 'Pi Sco', x: 280, y: 150 },
                    { name: 'Antares', x: 350, y: 180 },
                    { name: 'Sigma Sco', x: 370, y: 210 },
                    { name: 'Tau Sco', x: 390, y: 240 },
                    { name: 'Shaula', x: 420, y: 270 },
                    { name: 'Kappa Sco', x: 450, y: 290 }
                ],
                connections: [
                    [0, 1], [1, 2], [1, 3],
                    [3, 4], [4, 5], [5, 6], [6, 7]
                ]
            },
            5: { 
                name: 'Cygnus', 
                stars: [
                    { name: 'Deneb', x: 400, y: 100 },
                    { name: 'Sadr', x: 400, y: 180 },
                    { name: 'Gienah', x: 340, y: 220 },
                    { name: 'Delta Cyg', x: 460, y: 220 },
                    { name: 'Albireo', x: 400, y: 280 }
                ],
                connections: [
                    [0, 1], [1, 2], [1, 3], [1, 4]
                ]
            }
        };

        let budget, skyClarity = 0, totalPollutionReduced = 0, selectedZone = null, timeLeft, gameActive = false, score = 0;
        let clarityGoal, pollutionCreep, creepInterval;
        let currentConstellation = null;
        const stars = [];
        let scatteredStars = [];
        const MAX_STARS = 50;
        let totalStarsCollected = 0;
        let gameTimerInterval, pollutionTimeout, eventTimeout;

        function playSound(sound) {
            try { sound.play(); } catch (e) { console.log("Audio failed:", e); }
        }

        function initGame() {
            const difficulty = document.getElementById('difficulty').value;
            timeLeft = difficultySettings[difficulty].time;
            budget = difficultySettings[difficulty].budget;
            pollutionCreep = difficultySettings[difficulty].pollutionCreep;
            creepInterval = difficultySettings[difficulty].creepInterval;
            skyClarity = 0;
            totalPollutionReduced = 0;
            totalStarsCollected = 0;
            score = 0;
            Object.values(solutions).forEach(sol => {
                sol.upgraded = false;
                document.getElementById(Object.keys(solutions).find(key => solutions[key] === sol)).classList.remove('upgraded');
            });

            const constellationKeys = Object.keys(properConstellations);
            const randomKey = constellationKeys[Math.floor(Math.random() * constellationKeys.length)];
            currentConstellation = properConstellations[randomKey];
            clarityGoal = currentConstellation.stars.length;

            budgetEl.textContent = `Budget: $${budget}`;
            timerEl.textContent = `Time: ${Math.floor(timeLeft / 60)}:${(timeLeft % 60).toString().padStart(2, '0')}`;
            clarityEl.textContent = `Stars: ${skyClarity}`;
            Object.keys(zones).forEach(zone => {
                zones[zone].lightLevel = difficulty === 'hard' ? zones[zone].originalLight + 20 : zones[zone].originalLight;
                zones[zone].originalLight = zones[zone].lightLevel;
                zones[zone].el.style.opacity = 1;
            });
            updateTable();
            gameContainer.style.display = 'block';
            constellationLines.innerHTML = '';
            constellationLines.style.opacity = '0';
        }

        function generateStars() {
            stars.forEach(star => star.remove());
            stars.length = 0;
            scatteredStars.forEach(star => star.remove());
            scatteredStars.length = 0;

            currentConstellation.stars.forEach((pos, i) => {
                const star = document.createElement('div');
                star.className = 'star';
                const size = 10 + Math.random() * 4;
                star.style.width = `${size}px`;
                star.style.height = `${size}px`;
                star.innerHTML = `<svg viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>`;
                star.style.left = `${pos.x}px`;
                star.style.top = `${pos.y}px`;
                star.dataset.index = i;
                if (pos.name) {
                    const label = document.createElement('span');
                    label.textContent = pos.name;
                    label.style.position = 'absolute';
                    label.style.color = '#00ff99';
                    label.style.fontSize = '12px';
                    label.style.left = `${size + 5}px`;
                    label.style.top = '-5px';
                    label.style.opacity = i < skyClarity ? '1' : '0';
                    label.className = 'star-label';
                    star.appendChild(label);
                }
                star.classList.toggle('visible', i < skyClarity);
                gameContainer.appendChild(star);
                stars.push(star);
            });

            const extraStars = MAX_STARS - clarityGoal;
            for (let i = 0; i < extraStars; i++) {
                const star = document.createElement('div');
                star.className = 'star scattered';
                const size = 8 + Math.random() * 4;
                star.style.width = `${size}px`;
                star.style.height = `${size}px`;
                star.innerHTML = `<svg viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>`;
                let x, y;
                do {
                    x = Math.random() * 850;
                    y = Math.random() * 600;
                } while (x > 250 && x < 550 && y > 100 && y < 310);
                star.style.left = `${x}px`;
                star.style.top = `${y}px`;
                star.classList.remove('visible');
                gameContainer.appendChild(star);
                scatteredStars.push(star);
            }
        }

        function updateScatteredStars() {
            const extraStars = MAX_STARS - clarityGoal;
            const starsBeyondConstellation = Math.max(0, totalStarsCollected - clarityGoal);
            scatteredStars.forEach((star, i) => {
                star.classList.toggle('visible', i < starsBeyondConstellation);
            });
            clarityEl.textContent = `Stars: ${skyClarity}`;
        }

        function drawConstellation() {
            constellationLines.innerHTML = '';
            const { connections } = currentConstellation;
            if (connections && skyClarity > 1) {
                connections.forEach(([startIdx, endIdx]) => {
                    if (startIdx < skyClarity && endIdx < skyClarity) {
                        const start = currentConstellation.stars[startIdx];
                        const end = currentConstellation.stars[endIdx];
                        constellationLines.innerHTML += `
                            <path d="M${start.x},${start.y} L${end.x},${end.y}" />
                        `;
                    }
                });
                constellationLines.style.opacity = '1';
            } else {
                constellationLines.style.opacity = '0';
            }
        }

        function startCountdown() {
            let count = 3;
            countdownEl.textContent = count;
            const countdown = setInterval(() => {
                count--;
                countdownEl.textContent = count;
                if (count <= 0) {
                    clearInterval(countdown);
                    startScreen.style.opacity = '0';
                    setTimeout(() => {
                        startScreen.style.display = 'none';
                        gameContainer.style.opacity = '1';
                        gameContainer.style.display = 'block';
                        zoneTable.style.display = 'block';
                        gameActive = true;
                        startGameTimer();
                        triggerRandomEvent();
                        increasePollution();
                    }, 500);
                }
            }, 1000);
        }

        function startGameTimer() {
            gameTimerInterval = setInterval(() => {
                if (!gameActive) return;
                timeLeft--;
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                timerEl.textContent = `Time: ${minutes}:${seconds.toString().padStart(2, '0')}`;
                if (timeLeft <= 0) {
                    timeLeft = 0; // Ensure time doesn't go below 0
                    endGame(false);
                }
            }, 1000);
        }

        Object.keys(zones).forEach(zone => {
            zones[zone].el.addEventListener('click', () => {
                if (!gameActive) return;
                if (selectedZone) selectedZone.el.classList.remove('selected');
                selectedZone = zones[zone];
                selectedZone.el.classList.add('selected');
                playSound(clickSound);
            });
            zones[zone].el.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                if (!gameActive || selectedZone !== zones[zone]) return;
                upgradeSolution();
            });
        });

        function upgradeSolution() {
            const lastAppliedBtn = Object.keys(solutions).find(btn => 
                document.getElementById(btn).lastClickTime && Date.now() - document.getElementById(btn).lastClickTime < 5000
            );
            if (!lastAppliedBtn) {
                showMessage('action', 'Apply a solution first to upgrade it!', '#ff3333');
                return;
            }
            const solution = solutions[lastAppliedBtn];
            if (solution.upgraded) {
                showMessage('action', `${solution.name} already upgraded!`, '#ff3333');
                return;
            }
            if (budget < solution.upgradeCost) {
                showMessage('action', `Need $${solution.upgradeCost} to upgrade ${solution.name}!`, '#ff3333');
                return;
            }
            budget -= solution.upgradeCost;
            solution.upgraded = true;
            document.getElementById(lastAppliedBtn).classList.add('upgraded');
            budgetEl.textContent = `Budget: $${budget}`;
            showMessage('action', `${solution.name} upgraded! Enhanced effects applied.`, '#ffcc00');
        }

        function applySolution(btnId) {
            if (!gameActive || !selectedZone) return;
            const solution = solutions[btnId];
            const effects = solution.upgraded ? solution.upgradedEffects : solution.effects;
            if (budget < solution.cost) {
                showMessage('action', `Not enough budget! Need $${solution.cost}, have $${budget}.`, '#ff3333');
                return;
            }
            const zoneKey = Object.keys(zones).find(key => zones[key] === selectedZone);
            document.getElementById(btnId).lastClickTime = Date.now();

            const reduced = Math.min(selectedZone.lightLevel, effects[zoneKey]);
            selectedZone.lightLevel = Math.max(0, selectedZone.lightLevel - reduced);
            budget -= solution.cost;
            totalPollutionReduced += reduced;
            let bonus = solution.optimalZone === zoneKey ? 50 : 0;
            if (bonus) budget += bonus;
            showMessage('action', bonus ? `Optimal! ${solution.name}: -${reduced} light, +$${bonus}` : `${solution.name}: -${reduced} light`, bonus ? '#00ff99' : '#ffffff');

            totalStarsCollected = Math.min(MAX_STARS, totalStarsCollected + Math.floor(totalPollutionReduced / 10));
            skyClarity = Math.min(clarityGoal, totalStarsCollected);
            budgetEl.textContent = `Budget: $${budget}`;
            updateUI();

            const totalLight = Object.values(zones).reduce((sum, zone) => sum + zone.lightLevel, 0);
            if (totalLight === 0) endGame(true);
        }

        function updateUI() {
            clarityEl.textContent = `Stars: ${skyClarity}`;
            stars.forEach((star, i) => {
                star.classList.toggle('visible', i < skyClarity);
                const label = star.querySelector('.star-label');
                if (label) label.style.opacity = i < skyClarity ? '1' : '0';
            });
            drawConstellation();
            updateScatteredStars();
            updateTable();
            updateZoneVisuals();
            if (totalStarsCollected >= clarityGoal && skyClarity === clarityGoal) {
                showMessage('event', `${currentConstellation.name} revealed! Clear all pollution to win!`, '#00ff99', 5000);
                playSound(winSound);
            }
        }

        Object.keys(solutions).forEach(btnId => {
            document.getElementById(btnId).addEventListener('click', () => {
                if (!gameActive) return;
                playSound(clickSound);
                applySolution(btnId);
            });
        });

        function updateTable() {
            tableBody.innerHTML = '';
            Object.keys(zones).forEach(zone => {
                const percentReduced = Math.round(((zones[zone].originalLight - zones[zone].lightLevel) / zones[zone].originalLight) * 100);
                tableBody.innerHTML += `
                    <tr>
                        <td>${zones[zone].el.textContent}</td>
                        <td>${zones[zone].originalLight}</td>
                        <td>${zones[zone].lightLevel}</td>
                        <td>${percentReduced}%</td>
                    </tr>
                `;
            });
        }

        function updateZoneVisuals() {
            Object.keys(zones).forEach(zone => {
                const ratio = zones[zone].lightLevel / zones[zone].originalLight;
                const opacity = Math.min(1, Math.max(0, ratio));
                zones[zone].el.style.opacity = 0.3 + (0.7 * opacity);
            });
        }

        function increasePollution() {
            if (!gameActive) return;
            const totalLight = Object.values(zones).reduce((sum, zone) => sum + zone.lightLevel, 0);
            if (totalLight <= 30) {
                pollutionTimeout = setTimeout(increasePollution, creepInterval);
                return;
            }
            const zoneKeys = Object.keys(zones);
            const randomZone = zones[zoneKeys[Math.floor(Math.random() * zoneKeys.length)]];
            if (randomZone.lightLevel < randomZone.originalLight * 1.5) {
                const increase = pollutionCreep;
                randomZone.lightLevel = Math.min(randomZone.originalLight * 1.5, randomZone.lightLevel + increase);
                showMessage('action', `${randomZone.el.textContent} pollution +${increase}!`, '#ff3333');
                updateTable();
                updateZoneVisuals();
            }
            pollutionTimeout = setTimeout(increasePollution, creepInterval);
        }

        const events = [
            { 
                text: "Residential protest! +20 pollution unless Dim Lights used next.", 
                effect: () => {
                    setTimeout(() => {
                        if (!document.getElementById('btn-dim').lastClickTime || Date.now() - document.getElementById('btn-dim').lastClickTime > 5000) {
                            zones.residential.lightLevel = Math.min(zones.residential.originalLight * 1.5, zones.residential.lightLevel + 20);
                            showMessage('action', "Residential protest: +20 pollution", '#ff3333');
                            updateTable();
                            updateZoneVisuals();
                        }
                    }, 5000);
                }
            },
            { 
                text: "Commercial boom! +$100 if Motion Sensors used.", 
                effect: () => {
                    if (document.getElementById('btn-motion').lastClickTime && Date.now() - document.getElementById('btn-motion').lastClickTime < 5000) {
                        budget += 100;
                        budgetEl.textContent = `Budget: $${budget}`;
                        showMessage('action', "Commercial boom: +$100", '#00ff99');
                    }
                }
            },
            { 
                text: "Park stargazing! +2 stars if pollution < 10.", 
                effect: () => {
                    if (zones.park.lightLevel < 10) {
                        totalStarsCollected = Math.min(MAX_STARS, totalStarsCollected + 2);
                        skyClarity = Math.min(clarityGoal, totalStarsCollected);
                        updateUI();
                        showMessage('action', "Park stargazing: +2 stars", '#00ff99');
                    }
                }
            }
        ];

        function triggerRandomEvent() {
            if (!gameActive) return;
            const event = events[Math.floor(Math.random() * events.length)];
            playSound(eventSound);
            eventMessage.textContent = event.text;
            eventMessage.style.opacity = 1;
            event.effect();
            setTimeout(() => eventMessage.style.opacity = 0, 3000);
            eventTimeout = setTimeout(triggerRandomEvent, Math.random() * 20000 + 10000);
        }

        function showMessage(type, text, color, duration = 3000) {
            const el = document.getElementById(`${type}-message`);
            el.textContent = text;
            el.style.color = color;
            el.style.opacity = 1;
            setTimeout(() => el.style.opacity = 0, duration);
        }

        function endGame(won) {
            gameActive = false;
            clearInterval(gameTimerInterval);
            clearTimeout(pollutionTimeout);
            clearTimeout(eventTimeout);
            score = totalPollutionReduced + budget + timeLeft * 10;
            showEndDialogue(won);
        }
    </script>
</body>
</html>