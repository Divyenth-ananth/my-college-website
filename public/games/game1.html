<!DOCTYPE html>
<html>
<head>
    <title>EcoVerse: Tirupati's Green Quest</title>
    <style>
        body {
            font-family: 'Quicksand', Arial, sans-serif;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            background: linear-gradient(135deg, #A3D8F4 0%, #B8E4C9 70%, #1A7F71 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            overflow: auto;
        }
        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDBweCIgdmlld0JveD0iMCAwIDE5MjAvMTAwIiB2ZXJzaW9uPSIxLjEiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiPjxwYXRoIGQ9Ik0wLDEwMEw2NDAsODBMMTI4MCwxMDBMMTkyMCw3MFYzMDAwSDBWMTAwWiIgZmlsbD0iIzJBOUQ4RiIgb3BhY2l0eT0iMC4yIi8+PC9zdmc+') repeat;
            z-index: 0;
            pointer-events: none;
        }
        .city-planner {
            width: 100%;
            max-width: 1250px;
            height: 780px;
            display: flex;
            flex-direction: column;
            background: rgba(255, 255, 255, 0.98);
            border-radius: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.12);
            overflow: auto;
            position: relative;
            z-index: 1;
            margin: 20px;
        }
        .header {
            background: linear-gradient(90deg, #1A7F71, #3AB8A2);
            color: #FFFFFF;
            padding: 25px;
            text-align: center;
            font-size: 2.8em;
            font-weight: 700;
            border-bottom: 5px solid #B8E4C9;
            letter-spacing: 2px;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.8), 0 0 20px rgba(26, 127, 113, 0.6);
        }
        .main-area {
            display: flex;
            flex: 1;
            padding: 25px;
            gap: 25px;
        }
        #canvas-container {
            flex: 3;
            border: 4px solid #B8E4C9;
            border-radius: 12px;
            background: linear-gradient(180deg, #A3D8F4 0%, #F7F7F7 100%);
            overflow: hidden;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.06);
        }
        #city-canvas {
            max-width: 100%;
            max-height: 100%;
        }
        .sidebar {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: rgba(240, 240, 240, 0.95);
            border-radius: 12px;
            padding: 25px;
            gap: 20px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.06);
            position: relative;
        }
        .resource {
            background: #FFFFFF;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            cursor: grab;
            display: flex;
            align-items: center;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            user-select: none;
            -webkit-user-drag: element;
        }
        .resource:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.15);
        }
        .resource:active {
            cursor: grabbing;
        }
        .resource img {
            width: 45px;
            height: 45px;
            margin-right: 15px;
        }
        .resource span {
            font-weight: 600;
            color: #1A7F71;
            font-size: 1.2em;
        }
        .controls {
            background: rgba(184, 228, 201, 0.95);
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top: 5px solid #1A7F71;
            z-index: 5;
        }
        .control-item {
            font-size: 1.2em;
            color: #1A7F71;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .control-item img {
            width: 24px;
            height: 24px;
        }
        #next-year {
            padding: 12px 30px;
            background: #1A7F71;
            color: #FFFFFF;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.2em;
            transition: background 0.3s ease, transform 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        #next-year:hover {
            background: #3AB8A2;
            transform: translateY(-3px);
        }
        #next-year:active {
            transform: translateY(0);
        }
        #back-button {
            padding: 12px 20px;
            background: #B8E4C9;
            color: #1A7F71;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: background 0.3s ease, transform 0.2s ease;
        }
        #back-button:hover {
            background: #A3D8F4;
            transform: translateY(-3px);
        }
        #result {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(240, 240, 240, 0.98);
            padding: 35px;
            border-radius: 20px;
            box-shadow: 0 0 25px rgba(0, 0, 0, 0.15);
            text-align: center;
            max-width: 90%;
            width: 550px;
            z-index: 10;
            border: 3px solid #B8E4C9;
            animation: fadeIn 0.5s ease;
        }
        #initial-dialog, #section-dialog {
            display: block;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #F0F7F0, #FFFFFF);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            text-align: center;
            max-width: 90%;
            width: 400px; /* Narrowed from 600px */
            z-index: 20;
            border: 4px solid #1A7F71;
            animation: fadeIn 0.5s ease;
        }
        #section-dialog {
            display: none;
        }
        #intro-overlay {
            display: block;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 15;
        }
        #initial-dialog h2, #section-dialog h2 {
            color: #1A7F71;
            margin-top: 0;
            font-size: 2.5em;
            font-weight: 700;
            text-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        #initial-dialog p, #section-dialog p {
            font-size: 1.2em;
            color: #1A7F71;
            line-height: 1.6;
            margin: 15px 0;
        }
        #initial-dialog .buttons {
            margin: 25px 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 20px;
        }
        #initial-dialog button, #section-dialog button {
            padding: 12px 25px;
            background: #1A7F71;
            color: #FFFFFF;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.2em;
            transition: background 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        #initial-dialog button:hover, #section-dialog button:hover {
            background: #3AB8A2;
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
        }
        #chatbot-dialog {
            display: none;
            width: 100%;
            background: linear-gradient(135deg, #F0F7F0, #FFFFFF);
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
            border: 2px solid #1A7F71;
            padding: 15px;
            text-align: left;
            animation: fadeIn 0.5s ease;
            margin-top: 20px;
        }
        #chatbot-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
            vertical-align: middle;
        }
        #chatbot-dialog-message {
            font-size: 1em;
            color: #1A7F71;
            line-height: 1.5;
            display: inline-block;
            vertical-align: middle;
            max-width: calc(100% - 60px);
        }
        #chatbot-close {
            margin-top: 10px;
            padding: 8px 15px;
            background: #1A7F71;
            color: #FFFFFF;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background 0.3s ease, transform 0.2s ease;
            display: block;
            margin-left: auto;
        }
        #chatbot-close:hover {
            background: #3AB8A2;
            transform: translateY(-2px);
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        @media (max-width: 900px) {
            .city-planner {
                height: auto;
                max-width: 95%;
            }
            .main-area {
                flex-direction: column;
            }
            .sidebar {
                flex-direction: row;
                flex-wrap: wrap;
                justify-content: center;
            }
            .resource {
                flex: 1 1 45%;
                margin: 10px;
            }
            .controls {
                flex-direction: column;
                gap: 15px;
            }
            #city-canvas {
                width: 100%;
                height: auto;
            }
            #initial-dialog, #section-dialog {
                width: 90%;
                padding: 20px;
            }
            #chatbot-dialog {
                width: 100%;
                margin: 10px 0 0 0;
            }
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="city-planner" id="game-container" style="display: none;">
        <div class="header">EcoVerse: Tirupati's Green Quest</div>
        <div class="main-area">
            <div id="canvas-container">
                <canvas id="city-canvas" width="900" height="500"></canvas>
            </div>
            <div class="sidebar">
                <div class="resource" draggable="true" data-type="solar" data-cost="2000">
                    <img src="https://img.icons8.com/color/96/000000/solar-panel.png" alt="Solar Plant">
                    Solar Plant (<span id="solar-cost">2000</span>$)
                </div>
                <div class="resource" draggable="true" data-type="water" data-cost="1500">
                    <img src="https://img.icons8.com/color/96/000000/water-tower.png" alt="Water Tower">
                    Water Tower (<span id="water-cost">1500</span>$)
                </div>
                <div class="resource" draggable="true" data-type="factory" data-cost="3000">
                    <img src="https://img.icons8.com/fluency/96/000000/factory.png" alt="Factory">
                    Factory (<span id="factory-cost">3000</span>$)
                </div>
                <div id="chatbot-dialog">
                    <img id="chatbot-avatar" src="https://img.icons8.com/color/96/000000/bot.png" alt="Chatbot Avatar">
                    <span id="chatbot-dialog-message"></span>
                    <button id="chatbot-close" onclick="hideChatbotDialog()">Close</button>
                </div>
            </div>
        </div>
        <div class="controls">
            <div class="control-item">
                <img src="https://img.icons8.com/fluency/48/000000/calendar.png" alt="Year">
                Year: <span id="years">0</span>/5
            </div>
            <div class="control-item">
                <img src="https://img.icons8.com/fluency/48/000000/money-bag.png" alt="Funds">
                Funds Left: $<span id="funds">10000</span>
            </div>
            <div class="control-item">
                <img src="https://img.icons8.com/fluency/48/000000/leaf.png" alt="Sustainability">
                Sustainability: <span id="sustainability">50</span>%
            </div>
            <div class="control-item">
                <img src="https://img.icons8.com/color/48/000000/smoke.png" alt="Pollution">
                Pollution: <span id="pollution">0</span>%
            </div>
            <button id="next-year" onclick="nextYear()">
                <img src="https://img.icons8.com/fluency/48/000000/fast-forward.png" alt="Next" style="width: 24px; vertical-align: middle;">
                Next Year
            </button>
            <button id="back-button" onclick="showInitialDialog()">Back</button>
        </div>
        <div id="result">
            <h2>Game Over!</h2>
            <p id="outcome"></p>
            <p id="suggestions"></p>
            <button onclick="resetGame()">Play Again</button>
        </div>
    </div>
    <div id="intro-overlay"></div>
    <div id="initial-dialog">
        <h2>EcoVerse: Tirupati's Green Quest</h2>
        <p>Welcome, Eco Warrior! Transform Tirupati into a sustainable paradise.</p>
        <div class="buttons">
            <button onclick="startGame()">Start Game</button>
            <button onclick="showSection('how-to')">How to Play the Game</button>
            <button onclick="showSection('about')">About the Game</button>
        </div>
    </div>
    <div id="section-dialog">
        <h2 id="section-title"></h2>
        <p id="section-content"></p>
        <button onclick="showInitialDialog()">Back</button>
    </div>

    <script>
        const canvas = document.getElementById("city-canvas");
        const ctx = canvas.getContext("2d");
        let funds = 10000;
        let sustainability = 50;
        let pollution = 0;
        let years = 0;
        let buildings = [];
        let pollutionParticles = [];

        let buildingCounts = { solar: 0, water: 0, factory: 0 };

        const images = {
            solar: new Image(),
            water: new Image(),
            factory: new Image(),
            house: new Image(),
            temple: new Image(),
            isckon: new Image(),
            railway: new Image(),
            tree: new Image(),
            collegeIIT: new Image(),
            collegeIISER: new Image()
        };
        images.solar.src = 'https://img.icons8.com/color/96/000000/solar-panel.png';
        images.water.src = 'https://img.icons8.com/color/96/000000/water-tower.png';
        images.factory.src = 'https://img.icons8.com/fluency/96/000000/factory.png';
        images.house.src = 'https://img.icons8.com/color/96/000000/home.png';
        images.temple.src = 'https://img.icons8.com/color/96/000000/pagoda.png';
        images.isckon.src = 'https://img.icons8.com/color/96/000000/pagoda.png';
        images.railway.src = 'https://img.icons8.com/color/96/000000/train-station.png';
        images.tree.src = 'https://img.icons8.com/color/96/000000/forest.png';
        images.collegeIIT.src = 'https://img.icons8.com/color/96/000000/university.png';
        images.collegeIISER.src = 'https://img.icons8.com/color/96/000000/university.png';

        let imagesLoaded = 0;
        const totalImages = 10;

        function handleImageLoad() {
            imagesLoaded++;
            if (imagesLoaded === totalImages) {
                drawCity();
                setupDragEvents();
            }
        }

        function handleImageError(event) {
            console.error(`Image failed to load: ${event.target.src}`);
            imagesLoaded++;
            if (imagesLoaded === totalImages) {
                drawCity();
                setupDragEvents();
            }
        }

        for (let key in images) {
            images[key].onload = handleImageLoad;
            images[key].onerror = handleImageError;
        }

        setTimeout(() => {
            if (imagesLoaded < totalImages) {
                console.warn("Images took too long, forcing draw");
                drawCity();
                setupDragEvents();
            }
        }, 5000);

        function startGame() {
            document.getElementById("initial-dialog").style.display = "none";
            document.getElementById("section-dialog").style.display = "none";
            document.getElementById("intro-overlay").style.display = "none";
            document.getElementById("game-container").style.display = "flex";
            showChatbotDialog("default");
        }

        function showInitialDialog() {
            document.getElementById("game-container").style.display = "none";
            document.getElementById("section-dialog").style.display = "none";
            document.getElementById("initial-dialog").style.display = "block";
            document.getElementById("intro-overlay").style.display = "block";
        }

        function showSection(section) {
            document.getElementById("initial-dialog").style.display = "none";
            document.getElementById("section-dialog").style.display = "block";
            const title = document.getElementById("section-title");
            const content = document.getElementById("section-content");
            switch (section) {
                case "about":
                    title.textContent = "About the Game";
                    content.textContent = "EcoVerse raises awareness about sustainability by simulating Tirupati’s urban planning. Players balance economic growth with environmental health, learning how solar plants reduce pollution, water towers sustain life, and factories pose risks—mirroring real-world eco-challenges.";
                    break;
                case "how-to":
                    title.textContent = "How to Play the Game";
                    content.textContent = "1. Drag solar plants ($2000), water towers ($1500), or factories ($3000) onto the canvas. 2. Place factories away from homes to avoid pollution penalties. 3. Click 'Next Year' to advance time (5 years total). 4. Keep pollution below 90% and boost sustainability to win!";
                    break;
            }
        }

        function setupDragEvents() {
            const resources = document.querySelectorAll('.resource');
            resources.forEach(resource => {
                resource.addEventListener('dragstart', (event) => {
                    const type = resource.getAttribute('data-type');
                    const cost = parseInt(resource.getAttribute('data-cost'));
                    event.dataTransfer.setData('text/plain', JSON.stringify({ type, cost }));
                });
            });

            canvas.addEventListener('dragover', (event) => event.preventDefault());

            canvas.addEventListener('drop', (event) => {
                event.preventDefault();
                const data = JSON.parse(event.dataTransfer.getData('text/plain'));
                const { type, cost } = data;
                const rect = canvas.getBoundingClientRect();
                const x = event.clientX - rect.left;
                const y = event.clientY - rect.top;

                if (canPlaceBuilding(type, cost, x, y)) {
                    placeBuilding(type, x, y);
                    updateFunds(cost);
                    updateStats(type);
                    showChatbotDialog(type);
                    drawCity();
                } else {
                    showChatbotDialog(type === "factory" ? "factory_restricted" : "error");
                }
            });
        }

        const residentialBuildings = [
            { x: 230, y: 420 }, { x: 340, y: 430 },
            { x: 280, y: 200 }, { x: 340, y: 170 }
        ];

        function canPlaceBuilding(type, cost, x, y) {
            if (years >= 5 || pollution >= 90 || funds < cost) return false;
            if (type === "factory") {
                for (let house of residentialBuildings) {
                    if (Math.hypot(x - house.x, y - house.y) < 100) return false;
                }
            }
            return true;
        }

        const solarMessages = [
            "Great move! Solar power keeps Tirupati clean. In 2011, Fukushima’s nuclear disaster showed renewables’ safety—solar avoids such risks!",
            "Another solar plant? Smart! Germany’s solar boom cut CO2 by 35M tons since 2000, proving long-term pollution reduction.",
            "More solar! Unlike Chernobyl’s 1986 meltdown, solar keeps the air holy and safe for generations.",
            "Solar’s piling up! No Three Mile Island 1979 here—clean energy keeps Tirupati thriving."
        ];
        const waterMessages = [
            "Nice! Water towers ensure health. Flint, Michigan’s 2014 crisis poisoned 100,000—clean water prevents that!",
            "Another water tower? Chennai’s 2019 drought left millions dry—steady supply avoids such chaos!",
            "Water’s flowing! India’s 1970s Ganges pollution killed ecosystems—towers keep Tirupati’s rivers alive.",
            "More water towers! No 2004 Asian tsunami chaos here—reliable water supports life and crops."
        ];
        const factoryMessages = [
            "Factories boost jobs, but beware! Bhopal 1984 leaked gas, killing 3,000 instantly—pollution’s deadly cost!",
            "Another factory? LA’s 1940s smog sickened thousands—decades of haze followed unchecked industry!",
            "Factories again? China’s 2013 haze cut life expectancy by 5 years—solar could offset this!",
            "More factories! London’s 1952 smog killed 4,000 in weeks—CO2 piles up fast without balance!"
        ];

        function placeBuilding(type, x, y) {
            buildings.push({ type, x, y, pollutionLevel: type === "factory" ? 1 : 0 });
            buildingCounts[type]++;
        }

        function updateFunds(cost) {
            funds -= cost;
            document.getElementById("funds").textContent = funds;
        }

        function updateStats(type) {
            if (type === "solar") sustainability = Math.min(100, sustainability + 10);
            else if (type === "water") sustainability = Math.min(100, sustainability + 5);
            else if (type === "factory") {
                sustainability = Math.max(0, sustainability - 15);
                pollution = Math.min(100, pollution + 10);
            }
            document.getElementById("sustainability").textContent = sustainability;
            document.getElementById("pollution").textContent = pollution;
        }

        function createPollutionParticle(x, y) {
            return {
                x,
                y,
                size: Math.random() * 3 + 1,
                vx: (Math.random() - 0.5) * 2,
                vy: (Math.random() - 0.5) * 2 - 1,
                life: 60 + Math.random() * 40,
                opacity: 0.8
            };
        }

        function drawCity() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Base ground
            ctx.fillStyle = "#D2B48C"; // Sandy base color
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Grass layer
            ctx.fillStyle = "#B8E4C9";
            ctx.beginPath();
            ctx.moveTo(0, 500);
            ctx.quadraticCurveTo(300, 400, 450, 500);
            ctx.quadraticCurveTo(600, 450, 900, 500);
            ctx.lineTo(900, 500);
            ctx.lineTo(0, 500);
            ctx.fill();

            // Hills
            ctx.fillStyle = "#1A7F71";
            ctx.beginPath();
            ctx.moveTo(0, 0);
            ctx.lineTo(150, 70);
            ctx.lineTo(300, 40);
            ctx.lineTo(450, 80);
            ctx.lineTo(600, 50);
            ctx.lineTo(750, 90);
            ctx.lineTo(900, 60);
            ctx.lineTo(900, 0);
            ctx.lineTo(0, 0);
            ctx.fill();

            ctx.beginPath();
            ctx.moveTo(400, 500);
            ctx.quadraticCurveTo(460, 400, 520, 500);
            ctx.fillStyle = "linear-gradient(to top, #4A704A, #B8E4C9)";
            ctx.fill();
            ctx.fillStyle = "#1A7F71";
            ctx.font = "10px Quicksand";
            ctx.fillText("Alipiri Hills", 450, 470);

            // Improved Roads
            const roadBaseGradient = ctx.createLinearGradient(0, 50, 0, 500);
            roadBaseGradient.addColorStop(0, "#2F2F2F"); // Darker asphalt
            roadBaseGradient.addColorStop(0.5, "#4A4A4A"); // Mid-tone
            roadBaseGradient.addColorStop(1, "#606060"); // Lighter asphalt

            // Main Road - Natural and less sharp near Tirumala
            ctx.fillStyle = roadBaseGradient;
            ctx.shadowColor = "rgba(0, 0, 0, 0.5)";
            ctx.shadowBlur = 15;
            ctx.shadowOffsetY = 6;
            ctx.beginPath();
            ctx.moveTo(400, 500);
            ctx.quadraticCurveTo(400, 350, 420, 200); // Smoother curve
            ctx.quadraticCurveTo(430, 120, 440, 100); // Gentle near Tirumala
            ctx.lineTo(480, 100);
            ctx.quadraticCurveTo(490, 120, 500, 200);
            ctx.quadraticCurveTo(520, 350, 520, 500);
            ctx.fill();
            ctx.shadowBlur = 0;
            ctx.shadowOffsetY = 0;

            // Road borders (sidewalks)
            ctx.strokeStyle = "#B0B0B0";
            ctx.lineWidth = 8;
            ctx.beginPath();
            ctx.moveTo(400, 500);
            ctx.quadraticCurveTo(400, 350, 420, 200);
            ctx.quadraticCurveTo(430, 120, 440, 100);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(480, 100);
            ctx.quadraticCurveTo(490, 120, 500, 200);
            ctx.quadraticCurveTo(520, 350, 520, 500);
            ctx.stroke();

            // Centerline (yellow)
            ctx.strokeStyle = "#FFD700";
            ctx.lineWidth = 3;
            ctx.setLineDash([15, 10]);
            ctx.beginPath();
            ctx.moveTo(450, 500);
            ctx.quadraticCurveTo(450, 350, 460, 200);
            ctx.quadraticCurveTo(465, 120, 470, 100);
            ctx.stroke();
            ctx.setLineDash([]);

            // Side Road Right
            ctx.fillStyle = roadBaseGradient;
            ctx.shadowBlur = 15;
            ctx.shadowOffsetY = 5;
            ctx.beginPath();
            ctx.moveTo(520, 300);
            ctx.quadraticCurveTo(650, 320, 780, 300);
            ctx.lineTo(800, 300);
            ctx.quadraticCurveTo(670, 320, 540, 300);
            ctx.fill();
            ctx.shadowBlur = 0;
            ctx.shadowOffsetY = 0;
            ctx.strokeStyle = "#B0B0B0";
            ctx.lineWidth = 8;
            ctx.beginPath();
            ctx.moveTo(520, 300);
            ctx.quadraticCurveTo(650, 320, 780, 300);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(800, 300);
            ctx.quadraticCurveTo(670, 320, 540, 300);
            ctx.stroke();
            ctx.strokeStyle = "#FFD700";
            ctx.lineWidth = 3;
            ctx.setLineDash([15, 10]);
            ctx.beginPath();
            ctx.moveTo(530, 300);
            ctx.quadraticCurveTo(660, 320, 790, 300);
            ctx.stroke();
            ctx.setLineDash([]);

            // Side Road Left
            ctx.fillStyle = roadBaseGradient;
            ctx.shadowBlur = 15;
            ctx.shadowOffsetY = 5;
            ctx.beginPath();
            ctx.moveTo(400, 300);
            ctx.quadraticCurveTo(320, 320, 240, 300);
            ctx.lineTo(220, 300);
            ctx.quadraticCurveTo(300, 320, 380, 300);
            ctx.fill();
            ctx.shadowBlur = 0;
            ctx.shadowOffsetY = 0;
            ctx.strokeStyle = "#B0B0B0";
            ctx.lineWidth = 8;
            ctx.beginPath();
            ctx.moveTo(400, 300);
            ctx.quadraticCurveTo(320, 320, 240, 300);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(220, 300);
            ctx.quadraticCurveTo(300, 320, 380, 300);
            ctx.stroke();
            ctx.strokeStyle = "#FFD700";
            ctx.lineWidth = 3;
            ctx.setLineDash([15, 10]);
            ctx.beginPath();
            ctx.moveTo(390, 300);
            ctx.quadraticCurveTo(310, 320, 230, 300);
            ctx.stroke();
            ctx.setLineDash([]);

            // Static icons (trees adjusted to avoid roads)
            const trees = [
                { x: 150, y: 450 }, { x: 200, y: 400 }, { x: 600, y: 450 },
                { x: 550, y: 200 }, { x: 650, y: 150 }, { x: 700, y: 200 },
                { x: 300, y: 100 }, { x: 500, y: 100 }, { x: 100, y: 200 }
            ];
            trees.forEach(tree => {
                if (images.tree.complete && images.tree.naturalWidth !== 0) {
                    ctx.drawImage(images.tree, tree.x - 20, tree.y - 20, 40, 40);
                }
            });

            // Tirumala Temple left of the road
            if (images.temple.complete && images.temple.naturalWidth !== 0) {
                ctx.shadowColor = "rgba(0, 0, 0, 0.3)";
                ctx.shadowBlur = 5;
                ctx.drawImage(images.temple, 330, 50, 50, 50);
                ctx.shadowBlur = 0;
            }
            ctx.fillStyle = "#1A7F71";
            ctx.font = "12px Quicksand";
            ctx.fillText("Tirumala Temple", 310, 110);

            if (images.isckon.complete && images.isckon.naturalWidth !== 0) {
                ctx.shadowColor = "rgba(0, 0, 0, 0.3)";
                ctx.shadowBlur = 5;
                ctx.drawImage(images.isckon, 300, 350, 50, 50);
                ctx.shadowBlur = 0;
            }
            ctx.fillStyle = "#1A7F71";
            ctx.font = "12px Quicksand";
            ctx.fillText("ISKCON Temple", 290, 410);

            if (images.collegeIIT.complete && images.collegeIIT.naturalWidth !== 0) {
                ctx.shadowColor = "rgba(0, 0, 0, 0.3)";
                ctx.shadowBlur = 5;
                ctx.drawImage(images.collegeIIT, 750, 400, 50, 50);
                ctx.shadowBlur = 0;
            }
            ctx.fillStyle = "#1A7F71";
            ctx.font = "10px Quicksand";
            ctx.fillText("IIT Tirupati", 740, 450);

            if (images.collegeIISER.complete && images.collegeIISER.naturalWidth !== 0) {
                ctx.drawImage(images.collegeIISER, 600, 380, 40, 40);
            }
            ctx.fillStyle = "#1A7F71";
            ctx.font = "10px Quicksand";
            ctx.fillText("IISER Tirupati", 590, 430);

            const pondScale = 1 - pollution / 200;
            ctx.save();
            ctx.translate(550, 150);
            ctx.scale(pondScale, pondScale);
            ctx.beginPath();
            ctx.moveTo(-25, -25);
            ctx.quadraticCurveTo(0, -40, 30, -25);
            ctx.quadraticCurveTo(50, 0, 25, 25);
            ctx.quadraticCurveTo(-5, 35, -35, 15);
            ctx.quadraticCurveTo(-45, -5, -25, -25);
            ctx.fillStyle = "#87CEFA";
            ctx.fill();
            ctx.strokeStyle = "#4682B4";
            ctx.lineWidth = 2;
            ctx.stroke();
            ctx.restore();
            ctx.fillStyle = "#1A7F71";
            ctx.font = "10px Quicksand";
            ctx.fillText("Kapila Theertham", 550, 190);

            // Adjusted Railway Station to avoid road overlap
            if (images.railway.complete && images.railway.naturalWidth !== 0) {
                ctx.drawImage(images.railway, 350, 360, 40, 40);
            }
            ctx.fillStyle = "#1A7F71";
            ctx.font = "10px Quicksand";
            ctx.fillText("Tirupati Railway Stn", 340, 410);

            residentialBuildings.forEach(pos => {
                if (images.house.complete && images.house.naturalWidth !== 0) {
                    ctx.shadowColor = "rgba(0, 0, 0, 0.2)";
                    ctx.shadowBlur = 4;
                    ctx.shadowOffsetX = 2;
                    ctx.shadowOffsetY = 2;
                    ctx.drawImage(images.house, pos.x - 20, pos.y - 20, 40, 40);
                    ctx.shadowBlur = 0;
                    ctx.shadowOffsetX = 0;
                    ctx.shadowOffsetY = 0;
                }
            });

            // Pollution overlay
            if (pollution > 0) {
                ctx.fillStyle = `rgba(105, 105, 105, ${pollution / 200})`;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            }

            // Pollution particles and dynamic buildings
            buildings.forEach(b => {
                if (b.type === "factory") {
                    const nearbySolar = buildings.filter(s => 
                        s.type === "solar" && 
                        Math.hypot(s.x - b.x, s.y - b.y) < 120
                    ).length;
                    b.pollutionLevel = Math.max(1 - (nearbySolar * 0.3), 0.2);
                    if (Math.random() < 0.3 * b.pollutionLevel) {
                        pollutionParticles.push(createPollutionParticle(b.x, b.y));
                    }
                }
            });

            pollutionParticles = pollutionParticles.filter(p => p.life > 0);
            pollutionParticles.forEach(p => {
                p.x += p.vx;
                p.y += p.vy;
                p.life--;
                p.opacity = p.life / 100;
                ctx.beginPath();
                ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                ctx.fillStyle = `rgba(105, 105, 105, ${p.opacity})`;
                ctx.fill();
            });

            buildings.forEach(b => {
                const size = b.type === "factory" ? 50 : 40;
                const offset = size / 2;
                ctx.shadowColor = "rgba(0, 0, 0, 0.2)";
                ctx.shadowBlur = 4;
                ctx.shadowOffsetX = 2;
                ctx.shadowOffsetY = 2;
                if (b.type === "solar" && images.solar.complete && images.solar.naturalWidth !== 0) {
                    ctx.drawImage(images.solar, b.x - offset, b.y - offset, size, size);
                } else if (b.type === "water" && images.water.complete && images.water.naturalWidth !== 0) {
                    ctx.drawImage(images.water, b.x - offset, b.y - offset, size, size);
                } else if (b.type === "factory" && images.factory.complete && images.factory.naturalWidth !== 0) {
                    ctx.drawImage(images.factory, b.x - offset, b.y - offset, size, size);
                }
                ctx.shadowBlur = 0;
                ctx.shadowOffsetX = 0;
                ctx.shadowOffsetY = 0;
            });

            requestAnimationFrame(drawCity);
        }

        function nextYear() {
            if (years < 5) {
                years++;
                document.getElementById("years").textContent = years;

                buildings.forEach(b => {
                    if (b.type === "factory") {
                        const nearbySolar = buildings.filter(s => 
                            s.type === "solar" && 
                            Math.hypot(s.x - b.x, s.y - b.y) < 120
                        ).length;
                        b.pollutionLevel = Math.min(b.pollutionLevel + 0.2 - (nearbySolar * 0.1), 2);
                        pollution = Math.min(100, pollution + (b.pollutionLevel * 5));
                        sustainability = Math.max(0, sustainability - (b.pollutionLevel * 3));
                        for (let i = 0; i < b.pollutionLevel * 2; i++) {
                            pollutionParticles.push(createPollutionParticle(b.x, b.y));
                        }
                    }
                    if (b.type === "solar") {
                        funds += 500;
                        sustainability = Math.min(100, sustainability + 5);
                        pollution = Math.max(0, pollution - 3);
                    }
                    if (b.type === "water") {
                        funds += 300;
                        sustainability = Math.min(100, sustainability + 3);
                    }
                });

                sustainability = Math.max(0, sustainability - 2);
                pollution = Math.min(100, pollution + 1);

                document.getElementById("funds").textContent = funds;
                document.getElementById("sustainability").textContent = Math.round(sustainability);
                document.getElementById("pollution").textContent = Math.round(pollution);

                if (pollution > 70) {
                    let index = Math.min(Math.floor(pollution / 20) - 3, 2);
                    showChatbotDialog("high_pollution", index);
                } else if (sustainability > 70) {
                    let index = Math.min(Math.floor(sustainability / 20) - 3, 2);
                    showChatbotDialog("high_sustainability", index);
                } else if (years === 3 && pollution < 30) {
                    showChatbotDialog("midway", Math.floor(Math.random() * 3));
                }

                if (years === 5 || pollution >= 100) showResult();
            }
        }

        function showResult() {
            const resultDiv = document.getElementById("result");
            const outcome = document.getElementById("outcome");
            const suggestions = document.getElementById("suggestions");
            resultDiv.style.display = "block";

            let solarCount = buildings.filter(b => b.type === "solar").length;
            let waterCount = buildings.filter(b => b.type === "water").length;
            let factoryCount = buildings.filter(b => b.type === "factory").length;
            let totalPollutionLevel = buildings.reduce((sum, b) => 
                b.type === "factory" ? sum + b.pollutionLevel : sum, 0);

            let score = (sustainability * 2) + (funds * 0.1) + (solarCount * 20) + (waterCount * 15) - (factoryCount * 10) - (pollution * 1.5);

            if (score >= 200 && pollution < 30) {
                outcome.textContent = "Sustainable Tirupati! A green paradise!";
                resultDiv.style.backgroundColor = "rgba(184, 228, 201, 0.95)";
                suggestions.textContent = "Perfect balance of progress and nature!";
                showChatbotDialog("win");
            } else if (score >= 100 && pollution < 60) {
                outcome.textContent = "Green Tirupati! A sustainable success.";
                resultDiv.style.backgroundColor = "rgba(255, 245, 200, 0.95)";
                suggestions.textContent = "Well done! Fine-tune pollution control.";
                showChatbotDialog("moderate");
            } else {
                outcome.textContent = "Polluted Tirupati! Sustainability failed.";
                resultDiv.style.backgroundColor = "rgba(220, 180, 130, 0.95)";
                suggestions.textContent = getLossSuggestions(solarCount, waterCount, factoryCount, totalPollutionLevel);
                showChatbotDialog("lose");
            }
        }

        function getLossSuggestions(solarCount, waterCount, factoryCount, totalPollutionLevel) {
            let tips = [];
            if (pollution > 70) tips.push("Pollution too high—add more solar plants near factories.");
            if (sustainability < 30) tips.push("Sustainability low—prioritize green buildings.");
            if (solarCount < factoryCount) tips.push("More solar needed to offset factories.");
            if (waterCount < 2) tips.push("Water towers boost sustainability.");
            return "Tips: " + (tips.length ? tips.join(" ") : "Focus on sustainability!");
        }

        function resetGame() {
            funds = 10000;
            sustainability = 50;
            pollution = 0;
            years = 0;
            buildings = [];
            pollutionParticles = [];
            document.getElementById("funds").textContent = funds;
            document.getElementById("years").textContent = years;
            document.getElementById("sustainability").textContent = sustainability;
            document.getElementById("pollution").textContent = pollution;
            document.getElementById("result").style.display = "none";
            showChatbotDialog("reset");
        }

        const chatbotDialog = document.getElementById("chatbot-dialog");
        const chatbotDialogMessage = document.getElementById("chatbot-dialog-message");

        function showChatbotDialog(type, index = null) {
            chatbotDialog.style.display = "block";
            chatbotDialog.style.animation = "fadeIn 0.5s ease";
            let message;
            if (index === null) index = Math.min(buildingCounts[type] || 0, 3);

            switch (type) {
                case "solar":
                    message = solarMessages[index];
                    break;
                case "water":
                    message = waterMessages[index];
                    break;
                case "factory":
                    message = factoryMessages[index];
                    break;
                case "factory_restricted":
                    message = "Factories can’t be near homes—keep the air clean!";
                    break;
                case "error":
                    message = "Not enough funds or game over!";
                    break;
                case "high_pollution":
                    message = ["Pollution’s rising! Beijing’s 2015 smog choked millions—don’t let Tirupati follow!",
                              "High pollution! Mexico City’s 1990s smog crippled health—act fast!",
                              "Factories dominate! Kanpur’s tanneries still poison the Ganges—scary precedent!"][index];
                    break;
                case "high_sustainability":
                    message = ["Wow, you’re a star! Tirupati’s thriving—like Copenhagen’s green model!",
                              "Sustainability’s soaring! Costa Rica hit 90% renewable energy—nice!",
                              "Society’s loving this! Bhutan’s carbon-negative success inspires us!"][index];
                    break;
                case "midway":
                    message = ["Halfway there! Society loves your green choices—keep it up!",
                              "Year 3 and clean? Freiburg, Germany’s green future shines here!",
                              "Mid-game strong! Solar wins—unlike Gary, Indiana’s steel smog!"][index];
                    break;
                case "win":
                    message = "You’re a legend! Unlike LA’s smog, Tirupati’s air stays pure!";
                    break;
                case "moderate":
                    message = "Solid work! Better than Delhi’s haze—society’s thriving!";
                    break;
                case "lose":
                    message = "Ouch! Like Bhopal’s tragedy, pollution hit society hard!";
                    break;
                case "reset":
                    message = "Fresh start! Let’s avoid a Bhopal rerun!";
                    break;
                default:
                    message = "Hey! Let’s make Tirupati a green haven—plan wisely!";
            }

            chatbotDialogMessage.textContent = message;
        }

        function hideChatbotDialog() {
            chatbotDialog.style.animation = "fadeOut 0.5s ease";
            setTimeout(() => {
                chatbotDialog.style.display = "none";
                chatbotDialog.style.animation = "";
            }, 500);
        }

        drawCity();
    </script>
</body>
</html>